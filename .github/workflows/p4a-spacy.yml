name: p4a spacy build

on:
  workflow_dispatch:
  push:
    paths:
      - ".ci/**"
      - "spacy/**"
      - ".github/workflows/p4a-spacy.yml"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache ccache
        uses: actions/cache@v5
        with:
          path: p4a-ccache
          key: ${{ runner.os }}-p4a-ccache-${{ hashFiles('.ci/**', 'spacy/**') }}
          restore-keys: |
            ${{ runner.os }}-p4a-ccache-

      - name: Prepare cache dirs
        run: |
          mkdir -p p4a-ccache p4a-output

      - name: Build p4a images
        run: |
          docker buildx build ".ci/build-env" --tag p4a/build-env \
            --load \
            --cache-from type=gha,scope=build-env \
            --cache-to type=gha,scope=build-env,mode=max
          docker build ".ci/bundle" --tag p4a/spacy \
            --build-arg "python_version=3.14.2" \
            --build-arg "requirements=spacy==3.8.11"

      - name: Run p4a build
        run: |
          docker run \
            -v "${{ github.workspace }}/p4a-ccache:/root/.ccache" \
            -v "${{ github.workspace }}/p4a-output:/root/.local/share" \
            -v "${{ github.workspace }}:/root/bundle/local_recipes" \
            p4a/spacy
      - name: Collect config.log files
        if: always()
        run: |
          mkdir -p p4a-logs
          if [ -d p4a-output ]; then
            find p4a-output -name config.log -type f -print -exec cp --parents {} p4a-logs/ \;
          fi

      - name: Upload p4a output
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: p4a-build-output
          path: p4a-output
      - name: Upload config logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: p4a-config-logs
          path: p4a-logs
