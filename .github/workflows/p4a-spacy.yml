name: p4a spacy build

on:
  workflow_dispatch:
  push:
    paths:
      - "**"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Cache ccache
        uses: actions/cache@v5
        with:
          path: p4a-ccache
          key: ${{ runner.os }}-p4a-ccache-${{ hashFiles('**') }}
          restore-keys: |
            ${{ runner.os }}-p4a-ccache-

      - name: Prepare cache dirs
        run: |
          mkdir -p p4a-ccache p4a-output

      - name: Build p4a images
        run: |
          REPO_LOWER="${GITHUB_REPOSITORY,,}"
          REGISTRY_IMAGE="ghcr.io/${REPO_LOWER}/p4a-build-env"
          docker buildx build ".ci/build-env" \
            --tag "${REGISTRY_IMAGE}:latest" \
            --tag "${REGISTRY_IMAGE}:${{ github.sha }}" \
            --cache-from type=registry,ref="${REGISTRY_IMAGE}:buildcache" \
            --cache-to type=registry,ref="${REGISTRY_IMAGE}:buildcache",mode=max \
            --push
          docker pull "${REGISTRY_IMAGE}:latest"
          docker build ".ci/bundle" --tag p4a/spacy \
            --pull \
            --build-arg "BASE_IMAGE=${REGISTRY_IMAGE}:latest" \
            --build-arg "python_version=3.14.2" \
            --build-arg "requirements=spacy==3.8.11"

      - name: Run p4a build
        run: |
          docker run \
            -v "${{ github.workspace }}/p4a-ccache:/root/.ccache" \
            -v "${{ github.workspace }}/p4a-output:/root/.local/share" \
            -v "${{ github.workspace }}:/root/bundle/local_recipes" \
            p4a/spacy

      - name: Collect config.log files
        if: always()
        run: |
          mkdir -p p4a-logs
          if [ -d p4a-output ]; then
            find p4a-output -name config.log -type f -print -exec cp --parents {} p4a-logs/ \;
          fi

      - name: Upload p4a output
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: p4a-build-output
          path: p4a-output

      - name: Upload config logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: p4a-config-logs
          path: p4a-logs
